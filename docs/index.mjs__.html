<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.mjs - ThuleJS</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://myproject.com" target="_blank" class="menu-item" id="website_link" >ThuleJS Website</a></h2><h2><a href="https://myproject.com.forum" target="_blank" class="menu-item" id="forum_link" >Forums</a></h2><h3>Modules</h3><ul><li><a href="module-ThuleJS-event.html">ThuleJS-event</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-ThuleJS-event.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="module-ThuleJS-event.html#.getEventTag">getEventTag</a></li><li data-type='method' style='display: none;'><a href="module-ThuleJS-event.html#.getResponseMap">getResponseMap</a></li><li data-type='method' style='display: none;'><a href="module-ThuleJS-event.html#.addResponse">addResponse</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="module-ThuleJS-event-processTag.html">processTag</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-ThuleJS-event.html">ThuleJS-event</a></li><li><a href="tutorial-ThuleJS-scopes.html">ThuleJS-scopes</a></li><li><a href="tutorial-ThulesJS-env.html">ThulesJS-env</a></li><li><a href="tutorial-index_.html">index</a></li><li><a href="tutorial-index.mjs.html">index.mjs</a></li><li><a href="tutorial-index.mjs_.html">index.mjs_</a></li><li><a href="tutorial-module-ThuleJS-event-processTag_.html">module-ThuleJS-event-processTag</a></li><li><a href="tutorial-module-ThuleJS-event_.html">module-ThuleJS-event</a></li><li><a href="tutorial-tutorial-ThuleJS-event.html">tutorial-ThuleJS-event</a></li><li><a href="tutorial-tutorial-ThuleJS-scopes.html">tutorial-ThuleJS-scopes</a></li><li><a href="tutorial-tutorial-ThulesJS-env.html">tutorial-ThulesJS-env</a></li><li><a href="tutorial-tutorial-index.mjs.html">tutorial-index.mjs</a></li><li><a href="tutorial-tutorial-index_.html">tutorial-index_</a></li><li><a href="tutorial-tutorial-module-ThuleJS-event-processTag_.html">tutorial-module-ThuleJS-event-processTag_</a></li><li><a href="tutorial-tutorial-module-ThuleJS-event_.html">tutorial-module-ThuleJS-event_</a></li><li><a href="tutorial-tutorial-tutorial-ThulesJS-env.html">tutorial-tutorial-ThulesJS-env</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">index.mjs</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module ThuleJS-event
 * @include README.md
 * @author Raymon van Dolder
 */

/**
 * --[ ThuleJS-event | event handler ]--
 * 
 */

//import { EventEmitter } from 'events';


import * as bin from './bin.mjs'
import defaultResponses from './defaultResponses.mjs'

const $EventMap = new Map();

const $levelTag = {
	'60' : "FATAL",     //proces failed, all stop
	'50' : "ERROR",     //proces failed, stop or keep going?
	'40' : "WARN",      //proces fail but keep running
	'30' : "INFO",      //proces completion or console
	'20' : "DEBUG",     //proces steps
	'10' : "TRACE"      //proces ports/byte level
}

export default{
    /**
     * @description Initialize optional settings for ThuleJS-event by passing an options object
     * @param {object} {options}
     * @property {boolean} console Activate hook on console.log
     * @property {boolean} format Activate hook on global Error classestest
     */
    init(options = {}){
        defaultResponses()

        //set controls on native console.log
        if(options.console) bin.logConsoleLog();
        
        //set triggers on Error &amp; Reference Error
        if(options.format){
            global.Error = eventError;
            global.ReferenceError = eventReferenceError;
            global.SyntaxError = eventSyntaxError;
            global.TypeError = eventTypeError;
        }
    },

    /**
     * Get a new event tag (event format)
     * @returns {class} new processTag | empty with methods
     */
    getEventTag(){
        return new processTag();
    },

    /**
     * Map object with all the responses listed by Level and Type
     * @returns {map} events response map
     */
    getResponseMap(){
        return $EventMap
    },

    /**
     * Adds a response to the EventMap.
     * Multiple responses for each Level and Type possible.
     * 
     * @param {number} level level of the event (50 for 'Error', 40 for 'Warn' etc.)
     * @param {string} type specific type of the event (Error, ReferenceError, TypeError etc.)
     * @param {function} response function that will run as response to the error
     * @returns {boolean}
     */
    addResponse(level, type, response){
        if(!level || !type || !response) return false
        addEventResponse(level, type, response)
        return true
    }
    
}

/**
 * format event: Takes the event and places all items in placeholders and adds meta information
 * @class
 */
class processTag {
    /** @private */
    #event = {}

    /**
     * 
     * @param {number} level level of the event
     * @param {string} type specific type of the event (Error, ReferenceError, TypeError etc.)
     * @param {function} event Parsed event to be formatted
     * @returns {object} 
     */
    constructor(level, type, event){
        if(!level || !type || !event) return
        
        this.#formatEvent(level, type, event)
        return this.#event
    }

    #formatEvent(level, type, event){
        this.#event.level = $levelTag[level]
        this.#event.timestamp  = new Date().toLocaleString('en-US',{hour12: false}).replace(/,/, '').replaceAll(/\//g, '-')
        
        const LineOfError = bin.getLineOfError(event.stack)
        if(LineOfError &amp;&amp; LineOfError[0] &amp;&amp; LineOfError[1]){
            this.#event.file = LineOfError[0] 
            this.#event.line = LineOfError[1]
        }
        
        if(!this.#event.type) this.#event.type =  event.type || event.name || type

        if(event.code &amp;&amp; !this.#event.code)         this.#event.code    = event.code;
        if(event.message &amp;&amp; !this.#event.message)   this.#event.message = event.message; 
        this.#event.processID  = event.pid || process.pid
        this.#event.parentID   = event.parent || process.ppid
        this.#event.stack      = event.stack || event
    }
        
    tag(_sID){ this.#event.id = _sID }

    type(_sType){ this.#event.type = _sType }
    
    data(_oData){ this.#event.data = _oData }

    msg(_sMsg){ this.#event.message = _sMsg }

    getTag() { return this.#event }

    #checkEventType(e){
        if(!this.#event.type) this.#event.type = e.name || e.type || 'Error'
    }

    fatal(e){
        this.#checkEventType(this.#event)
        this.#formatEvent(60, this.#event.type, e)
        eventHandler(60, this.#event.type, this.#event)
        this.#event = {} //reset tag after use
	}

    error(e){
        this.#checkEventType(this.#event)
        this.#formatEvent(50, this.#event.type, e)
        eventHandler(50, this.#event.type, this.#event)
        this.#event = {} //reset tag after Error
	}

    warn(e){
        this.#checkEventType(this.#event)
        this.#formatEvent(40, this.#event.type, e)
        eventHandler(40, this.#event.type, this.#event)
        this.#event = {} //reset tag after Error
	}

    info(e){
        this.#checkEventType(this.#event)
        this.#formatEvent(30, this.#event.type, e)
        eventHandler(30, this.#event.type, this.#event)
        this.#event = {} //reset tag after Error
	}

    debug(e){
        this.#checkEventType(this.#event)
        this.#formatEvent(20, this.#event.type, e)
        eventHandler(20, this.#event.type, this.#event)
        this.#event = {} //reset tag after Error
	}

    trace(e){
        this.#checkEventType(this.#event)
        this.#formatEvent(10, this.#event.type, e)
        eventHandler(10, this.#event.type, this.#event)
        this.#event = {} //reset tag after Error
	}
    
    
}

function addEventResponse(level, type, response) {
    if (!$EventMap.has(level)) {
      $EventMap.set(level, new Map());
    }
    const levelMap = $EventMap.get(level);
    if (!levelMap.has(type)) {
      levelMap.set(type, new Set());
    }
    levelMap.get(type).add(response);
}


function eventHandler(level, type, event, extend){
    if(!level || !type || !event) return
    // create new pT if extended from class
    if(extend) event = new processTag(level, type, event)

    if ($EventMap.has(level) &amp;&amp; $EventMap.get(level).has(event.type)) {
        $EventMap.get(level).get(event.type).forEach(response => response(event));
    } else {
        $EventMap.get(level).get('Default').forEach(response => response(event))
    }

    //call logger to log event
    // logger(level, event)

}


// ================================
//  --[ Error | class hooks ]--
// ================================

class eventError extends Error{
    constructor(error){
        super(error)
        if(typeof error !== 'object') error = {error}
        eventHandler(50, 'Error', error, true)
    }
}
class eventReferenceError extends ReferenceError{
    constructor(referenceError){
        super(referenceError)
        if(typeof referenceError !== 'object') referenceError = {referenceError}
        eventHandler(50, 'ReferenceError', referenceError, true)
    }
}
class eventSyntaxError extends SyntaxError{
    constructor(syntaxError){
        super(syntaxError)
        if(typeof syntaxError !== 'object') syntaxError = {syntaxError}
        eventHandler(50, 'SyntaxError', syntaxError, true)
    }
}
class eventTypeError extends TypeError{
    constructor(typeError){
        super(typeError)
        if(typeof typeError !== 'object') typeError = {typeError}
        eventHandler(50, 'TypeError', typeError, true)
    }
}

// ================================
// --[ custom | Error classes ]--
// ================================

class DatabaseError extends Error {
    constructor(code, event) {
        super(event);
        if(typeof event !== 'object') event = {event}
        event.type = 'DatabaseError'
        event.code = code
        eventHandler(50, 'DatabaseError', event, true)
    }
}
global.DatabaseError = DatabaseError</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
